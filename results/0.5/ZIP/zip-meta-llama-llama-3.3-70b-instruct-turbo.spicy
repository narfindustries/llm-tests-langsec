# ZIP File Format Specification in Zeek Spicy

# Define the ZIP file format
file ZIP {
    # Local file header
    struct LocalFileHeader {
        uint16le signature = 0x04034b50; # Local file header signature
        uint16le version; # Minimum ZIP specification version
        uint16le flags; # General purpose bit flag
        uint16le compression_method; # Compression method
        uint16le last_modified_time; # Last modified time
        uint16le last_modified_date; # Last modified date
        uint32le crc32; # CRC-32 of uncompressed data
        uint32le compressed_size; # Compressed size
        uint32le uncompressed_size; # Uncompressed size
        uint16le file_name_length; # Length of file name
        uint16le extra_field_length; # Length of extra field
        byte[file_name_length] file_name; # File name
        byte[extra_field_length] extra_field; # Extra field
    }

    # Central directory file header
    struct CentralDirectoryFileHeader {
        uint32le signature = 0x02014b50; # Central directory file header signature
        uint16le version_made_by; # Version made by
        uint16le version_to_extract; # Version to extract
        uint16le flags; # General purpose bit flag
        uint16le compression_method; # Compression method
        uint16le last_modified_time; # Last modified time
        uint16le last_modified_date; # Last modified date
        uint32le crc32; # CRC-32 of uncompressed data
        uint32le compressed_size; # Compressed size
        uint32le uncompressed_size; # Uncompressed size
        uint16le file_name_length; # Length of file name
        uint16le extra_field_length; # Length of extra field
        uint16le file_comment_length; # Length of file comment
        uint16le disk_number_start; # Disk number start
        uint16le internal_file_attributes; # Internal file attributes
        uint32le external_file_attributes; # External file attributes
        uint32le local_header_offset; # Local header offset
        byte[file_name_length] file_name; # File name
        byte[extra_field_length] extra_field; # Extra field
        byte[file_comment_length] file_comment; # File comment
    }

    # End of central directory record
    struct EndOfCentralDirectoryRecord {
        uint32le signature = 0x06054b50; # End of central directory record signature
        uint16le disk_number; # Disk number
        uint16le central_directory_disk_number; # Central directory disk number
        uint16le central_directory_entries_this_disk; # Central directory entries this disk
        uint16le central_directory_total_entries; # Central directory total entries
        uint32le central_directory_size; # Central directory size
        uint32le central_directory_offset; # Central directory offset
        uint16le zip_file_comment_length; # Length of ZIP file comment
        byte[zip_file_comment_length] zip_file_comment; # ZIP file comment
    }

    # ZIP file structure
    LocalFileHeader local_file_header;
    byte[local_file_header.compressed_size] compressed_data;
    while (!eof()) {
        CentralDirectoryFileHeader central_directory_file_header;
    }
    EndOfCentralDirectoryRecord end_of_central_directory_record;
}