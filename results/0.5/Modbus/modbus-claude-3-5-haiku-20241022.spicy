module Modbus;

import spicy;

public type Message = unit {
    function is_request: bool = { return $$.transaction_id < 32768; }
    function is_response: bool = { return $$.transaction_id >= 32768; }

    transaction_id: uint16;
    protocol_id: uint16;
    length: uint16;
    unit_id: uint8;
    function_code: uint8;

    payload: bytes &length=(length - 2);

    on %init {
        if ( protocol_id != 0 )
            throw "Invalid Modbus protocol identifier";
    }
};

public type Request = unit {
    message: Message;
    
    conditions {
        message.is_request();
    }
};

public type Response = unit {
    message: Message;
    
    conditions {
        message.is_response();
    }
};