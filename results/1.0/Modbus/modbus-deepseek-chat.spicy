module Modbus;

import spicy;

public type Modbus_Header = unit {
    transaction_id: uint16;
    protocol_id: uint16;
    length: uint16;
    unit_id: uint8;
};

public type Modbus_PDU = unit {
    function_code: uint8;
    data: bytes &size=length-1;
};

public type Modbus_Message = unit {
    header: Modbus_Header;
    pdu: Modbus_PDU &length=header.length;
};

on Modbus_Message::%init {
    print "Modbus message received: transaction_id=%d, protocol_id=%d, length=%d, unit_id=%d, function_code=%d",
          self.header.transaction_id, self.header.protocol_id, self.header.length, self.header.unit_id, self.pdu.function_code;
}