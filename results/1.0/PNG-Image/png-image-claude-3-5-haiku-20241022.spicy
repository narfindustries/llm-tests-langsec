module PNG;

import spicy;

public type Image = unit {
    signature        : bytes(8) = b"\x89PNG\r\n\x1a\n";
    chunks           : Chunk[] where $ > 0;
};

type Chunk = unit {
    length           : uint32;
    type             : bytes(4);
    data             : bytes(self.length) if (self.type != b"IEND");
    crc              : uint32;
};

public type Header = unit {
    width            : uint32;
    height           : uint32;
    bit_depth        : uint8;
    color_type       : uint8;
    compression      : uint8;
    filter           : uint8;
    interlace        : uint8;
};

public function is_png(input: bytes) : bool {
    return |input| >= 8 && input[0:8] == b"\x89PNG\r\n\x1a\n";
}

public function extract_dimensions(input: bytes) : tuple<uint32, uint32> {
    local img = parse Image(input);
    for (chunk in img.chunks) {
        if (chunk.type == b"IHDR") {
            local header = parse Header(chunk.data);
            return (header.width, header.height);
        }
    }
    return (0, 0);
}