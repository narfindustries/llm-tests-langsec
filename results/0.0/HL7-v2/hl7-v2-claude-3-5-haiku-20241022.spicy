module HL7;

import spicy;

public type Message = unit {
    segments: Segment[] &eod;
};

public type Segment = unit {
    name: bytes &length=3;
    separator: bytes &length=1 = "|";
    fields: Field[] &separator(/\|/);
};

public type Field = unit {
    value: bytes &convert=spicy::decode_utf8(self);
};

public type Parser = unit {
    message: Message;
};

public function parse(data: bytes) : Message = {
    local parser = Parser(data);
    return parser.message;
};