module TIFF;

import spicy;

public type TIFF_Header = unit {
    magic: bytes &size=2;
    version: uint16;
    ifd_offset: uint32;
};

public type IFD_Entry = unit {
    tag: uint16;
    type: uint16;
    count: uint32;
    value_offset: uint32;
};

public type IFD = unit {
    num_entries: uint16;
    entries: IFD_Entry[] &until($$ == num_entries);
    next_ifd_offset: uint32;
};

public type TIFF_File = unit {
    header: TIFF_Header;
    ifds: IFD[] &until($$.next_ifd_offset == 0);
};

on TIFF_File::%init {
    if ( self.header.magic != b"II" && self.header.magic != b"MM" ) {
        print("Invalid TIFF magic number");
        return false;
    }
    return true;
}