module SQLITE3;

import spicy;

public type SQLiteHeader = unit {
    magic: bytes(4) &requires(self.magic == b"SQLi");
    page_size: uint16 be;
    write_version: uint8;
    read_version: uint8;
    reserved_space: uint8;
    max_payload_fraction: uint8;
    min_payload_fraction: uint8;
    leaf_payload_fraction: uint8;
    file_change_counter: uint32 be;
    database_size: uint32 be;
    first_freelist_page: uint32 be;
    total_freelist_pages: uint32 be;
    schema_cookie: uint32 be;
    schema_format: uint32 be;
    default_cache_size: uint32 be;
    largest_root_page: uint32 be;
    text_encoding: uint32 be;
    user_version: uint32 be;
    incremental_vacuum_mode: uint32 be;
    application_id: uint32 be;
    reserved: bytes(20);
    version_valid_for: uint32 be;
    sqlite_version: uint32 be;

    on %init {
        if ( self.magic != b"SQLi" )
            throw "Invalid SQLite header magic";
    }
};

public type SQLiteDatabase = unit {
    header: SQLiteHeader;
};

public type SQLiteRecord = unit {
    parse SQLiteDatabase;
};