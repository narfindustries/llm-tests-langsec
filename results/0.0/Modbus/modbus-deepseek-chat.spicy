module Modbus;

import spicy;

public type Modbus_Header = unit {
    transaction_id: uint16;
    protocol_id: uint16;
    length: uint16;
    unit_id: uint8;
};

public type Modbus_PDU = unit {
    function_code: uint8;
    data: bytes &size=length-1;
};

public type Modbus_Message = unit {
    header: Modbus_Header;
    pdu: Modbus_PDU;
};

on Modbus_Message::%init {
    if ( self.header.protocol_id != 0 ) {
        print "Invalid protocol ID";
        return;
    }
}

on Modbus_Message::%done {
    print "Modbus message processed";
}

export Modbus_Message;