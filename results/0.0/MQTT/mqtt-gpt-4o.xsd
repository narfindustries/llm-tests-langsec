<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
           xmlns:dfdl="http://www.ogf.org/dfdl/dfdl-1.0/"
           targetNamespace="http://example.com/mqtt"
           xmlns="http://example.com/mqtt"
           elementFormDefault="qualified"
           dfdl:format="true"
           dfdl:byteOrder="bigEndian"
           dfdl:encoding="utf-8">

    <xs:annotation>
        <xs:appinfo source="http://www.ogf.org/dfdl/">
            <dfdl:format ref="dfdl:GeneralFormat" />
        </xs:appinfo>
    </xs:annotation>

    <xs:element name="MQTTMessage">
        <xs:complexType>
            <xs:sequence>
                <xs:element name="FixedHeader" type="FixedHeaderType" />
                <xs:element name="VariableHeader" type="VariableHeaderType" minOccurs="0" />
                <xs:element name="Payload" type="PayloadType" minOccurs="0" />
            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <xs:complexType name="FixedHeaderType">
        <xs:sequence>
            <xs:element name="ControlPacketType" type="xs:unsignedByte" dfdl:length="4" dfdl:lengthUnits="bits" />
            <xs:element name="Flags" type="xs:unsignedByte" dfdl:length="4" dfdl:lengthUnits="bits" />
            <xs:element name="RemainingLength" type="xs:unsignedInt" dfdl:representation="binary" dfdl:length="1" dfdl:lengthUnits="bytes" />
        </xs:sequence>
    </xs:complexType>

    <xs:complexType name="VariableHeaderType">
        <xs:sequence>
            <xs:element name="ProtocolName" type="xs:string" dfdl:length="6" dfdl:lengthUnits="bytes" dfdl:encoding="utf-8" />
            <xs:element name="ProtocolLevel" type="xs:unsignedByte" dfdl:length="1" dfdl:lengthUnits="bytes" />
            <xs:element name="ConnectFlags" type="xs:unsignedByte" dfdl:length="1" dfdl:lengthUnits="bytes" />
            <xs:element name="KeepAlive" type="xs:unsignedShort" dfdl:representation="binary" dfdl:length="2" dfdl:lengthUnits="bytes" />
        </xs:sequence>
    </xs:complexType>

    <xs:complexType name="PayloadType">
        <xs:sequence>
            <xs:element name="ClientIdentifier" type="xs:string" dfdl:lengthKind="delimited" dfdl:encoding="utf-8" />
            <xs:element name="WillTopic" type="xs:string" dfdl:lengthKind="delimited" dfdl:occursCountKind="expression" dfdl:occursCount="{ $VariableHeader/ConnectFlags & 0x04 != 0 }" dfdl:encoding="utf-8" />
            <xs:element name="WillMessage" type="xs:string" dfdl:lengthKind="delimited" dfdl:occursCountKind="expression" dfdl:occursCount="{ $VariableHeader/ConnectFlags & 0x04 != 0 }" dfdl:encoding="utf-8" />
            <xs:element name="UserName" type="xs:string" dfdl:lengthKind="delimited" dfdl:occursCountKind="expression" dfdl:occursCount="{ $VariableHeader/ConnectFlags & 0x80 != 0 }" dfdl:encoding="utf-8" />
            <xs:element name="Password" type="xs:string" dfdl:lengthKind="delimited" dfdl:occursCountKind="expression" dfdl:occursCount="{ $VariableHeader/ConnectFlags & 0x40 != 0 }" dfdl:encoding="utf-8" />
        </xs:sequence>
    </xs:complexType>

</xs:schema>