module GZIP;

import spicy;

public type GZIP_Header = unit {
    magic: bytes &size=2 &convert=0x1f8b;
    compression_method: uint8;
    flags: uint8;
    mtime: uint32;
    xfl: uint8;
    os: uint8;
};

public type GZIP_Extra = unit {
    len: uint16;
    data: bytes &size=len;
};

public type GZIP_File = unit {
    header: GZIP_Header;
    extra: optional<GZIP_Extra> &if=self.header.flags & 0x04;
    name: optional<bytes> &until=b"\x00" &if=self.header.flags & 0x08;
    comment: optional<bytes> &until=b"\x00" &if=self.header.flags & 0x10;
    crc16: optional<uint16> &if=self.header.flags & 0x02;
    compressed_data: bytes &until=b"\x00\x00\x00\x00";
    crc32: uint32;
    isize: uint32;
};

on GZIP_File::%init {
    if ( self.header.compression_method != 8 )
        print "Unsupported compression method: ", self.header.compression_method;
}

on GZIP_File::%done {
    print "GZIP file processed successfully.";
}