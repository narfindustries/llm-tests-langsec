module JPEG;

import spicy;

public type JPEG_File = unit {
    magic: bytes &size=2 &convert=0xFFD8;
    segments: JPEG_Segment[] &until($input.eod());
};

type JPEG_Segment = unit {
    marker: bytes &size=2;
    length: uint16;
    data: bytes &size=length-2;
};

on JPEG_File::magic {
    if ( self.magic != b"\xFF\xD8" )
        throw InvalidFormat("Invalid JPEG magic number");
}

on JPEG_Segment::marker {
    if ( self.marker[0] != 0xFF )
        throw InvalidFormat("Invalid JPEG segment marker");
}

on JPEG_Segment::length {
    if ( self.length < 2 )
        throw InvalidFormat("Invalid JPEG segment length");
}