module DICOM;

import spicy;
import zeek;

public type DICOMMessage = unit {
    preamble: bytes &size=128;
    prefix: bytes &size=4 &check=(self.prefix == "\x44\x49\x43\x4D"); # "DICM"
    elements: array of DICOMElement;
};

public type DICOMElement = unit {
    tag: uint16;
    vr: uint16;
    length: uint32;
    value: bytes &size=self.length;
};

public global parse_dicom: function(input: string): DICOMMessage {
    return DICOMMessage(input);
}

event zeek_init() {
    local file = open("sample.dcm", "r");
    if ( file == nil ) {
        print("Failed to open DICOM file.");
        return;
    }

    local data = file.read(file.size());
    file.close();

    local dicom = parse_dicom(data);
    print(fmt("Parsed DICOM with %d elements", |dicom.elements|));
}
