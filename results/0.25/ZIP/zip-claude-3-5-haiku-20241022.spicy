module ZIP;

import spicy;

public type File = unit {
    signature: bytes &size=4 
        where $$ == b"PK\x03\x04" 
        || $$ == b"PK\x05\x06"  # Also handle end of central directory
        || $$ == b"PK\x07\x08"; # Spanning marker

    version_needed: uint16;
    general_flags: uint16;
    compression_method: uint16;
    last_mod_time: uint16;
    last_mod_date: uint16;
    crc32: uint32;
    compressed_size: uint32;
    uncompressed_size: uint32;
    filename_length: uint16;
    extra_field_length: uint16;

    filename: bytes &size=filename_length;
    extra_field: bytes &size=extra_field_length;

    on %done {
        print self;
    }
}

public type Parser = unit {
    file: File;
}