module ZIP;

import spicy;

public type ZIP = unit {
    signature: bytes &size=4 &check=$$ == "\x50\x4b\x03\x04",
    version: uint16,
    flags: uint16,
    compression: uint16,
    mod_time: uint16,
    mod_date: uint16,
    crc32: uint32,
    compressed_size: uint32,
    uncompressed_size: uint32,
    filename_length: uint16,
    extra_field_length: uint16,
    filename: string &size=filename_length,
    extra_field: bytes &size=extra_field_length,
    data: bytes &size=compressed_size
};

public type ZIPFile = unit {
    files: ZIP[] &until=$input.eod()
};

public hook zeek_init() {
    Spicy::register_protocol_analyzer(
        "ZIP",
        &ZIPFile,
        &Spicy::ANALYZER_ZIP
    );
}