module PNG;

import spicy;

type IHDR = unit {
    width: uint32;
    height: uint32;
    bitDepth: uint8;
    colorType: uint8;
    compressionMethod: uint8;
    filterMethod: uint8;
    interlaceMethod: uint8;
};

type Chunk = unit {
    length: uint32;
    type: bytes &size=4;
    data: bytes &size=self.length;
    crc: uint32;
};

type PNGFile = unit {
    signature: bytes &size=8;
    chunks: Chunk[] &eod;
    
    on %init {
        if (self.signature != b"\x89PNG\r\n\x1a\n") {
            throw Error("Invalid PNG signature.");
        }
    }
};

public type File = unit {
    file: PNGFile;
    
    on %done {
        print self.file;
    }
};