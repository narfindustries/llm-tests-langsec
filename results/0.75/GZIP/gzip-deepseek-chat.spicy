module GZIP;

import spicy;

public type GZIP_Header = unit {
    magic: bytes &size=2 &convert=0x1f8b;
    compression_method: uint8;
    flags: uint8;
    mtime: uint32;
    xfl: uint8;
    os: uint8;
};

public type GZIP_Extra = unit {
    len: uint16;
    data: bytes &size=len;
};

public type GZIP_FileName = unit {
    name: bytes &until=b"\x00";
};

public type GZIP_Comment = unit {
    comment: bytes &until=b"\x00";
};

public type GZIP_CRC16 = unit {
    crc16: uint16;
};

public type GZIP_Trailer = unit {
    crc32: uint32;
    isize: uint32;
};

public type GZIP_Block = unit {
    header: GZIP_Header;
    extra: optional<GZIP_Extra> &if=self.header.flags & 0x04;
    name: optional<GZIP_FileName> &if=self.header.flags & 0x08;
    comment: optional<GZIP_Comment> &if=self.header.flags & 0x10;
    crc16: optional<GZIP_CRC16> &if=self.header.flags & 0x02;
    compressed_data: bytes &until=b"\x00";
    trailer: GZIP_Trailer;
};

public type GZIP_File = unit {
    blocks: GZIP_Block[];
};

on GZIP_File::%init {
    self.blocks = [];
}

on GZIP_Block::%done {
    self.trailer = GZIP_Trailer();
}

on GZIP_Header::%done {
    if (self.magic != 0x1f8b) {
        print("Invalid GZIP magic number");
        return false;
    }
    return true;
}